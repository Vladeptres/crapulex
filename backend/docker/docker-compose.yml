services:
  mongodb:
    image: mongo:7.0
    container_name: crapulex-mongo-${CONTAINER_SUFFIX}
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DB_NAME}
    command: mongod --bind_ip_all --port ${MONGO_DB_PORT}
    ports:
      - "${MONGO_DB_PORT}:${MONGO_DB_PORT}"
    volumes:
      - mongodb_data_${CONTAINER_SUFFIX}:/data/db
    networks:
      - ${NETWORK_NAME}

  redis:
    image: redis:7.2-alpine
    container_name: crapulex-redis-${CONTAINER_SUFFIX}
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --port ${REDIS_PORT}
    ports:
      - "${REDIS_PORT}:${REDIS_PORT}"
    volumes:
      - redis_data_${CONTAINER_SUFFIX}:/data
    networks:
      - ${NETWORK_NAME}

  minio:
    image: minio/minio:latest
    container_name: crapulex-minio-${CONTAINER_SUFFIX}
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio_data_${CONTAINER_SUFFIX}:/data
    networks:
      - ${NETWORK_NAME}

  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: crapulex-backend-${CONTAINER_SUFFIX}
    restart: unless-stopped
    environment:
      # Pass all environment variables from the env file to the container
      - ENVIRONNEMENT_NAME=${ENVIRONNEMENT_NAME}
      - API_PORT=${API_PORT}
      - MONGO_ROOT_USERNAME=${MONGO_ROOT_USERNAME}
      - MONGO_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
      - MONGO_DB_NAME=${MONGO_DB_NAME}
      - MONGO_DB_HOST=crapulex-mongo-${CONTAINER_SUFFIX}
      - MONGO_DB_PORT=${MONGO_DB_PORT}
      - CRAPULEX_SECRET_KEY=${CRAPULEX_SECRET_KEY}
      - DEBUG=${DEBUG}
      - REDIS_HOST=crapulex-redis-${CONTAINER_SUFFIX}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=${REDIS_DB}
      - REDIS_PORT=${REDIS_PORT}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      # Media storage: "s3://bucket-name" for AWS S3, or a local path for MinIO
      - MEDIA_STORAGE_URI=${MEDIA_STORAGE_URI:-media_files}
      # AWS S3 credentials (only needed when MEDIA_STORAGE_URI starts with s3://)
      - S3_REGION=${S3_REGION:-eu-north-1}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-}
      # MinIO credentials (only needed when MEDIA_STORAGE_URI is a local path)
      - MINIO_ENDPOINT=http://crapulex-minio-${CONTAINER_SUFFIX}:9000
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "${API_PORT}:${API_PORT}"
    depends_on:
      - mongodb
      - redis
      - minio
    networks:
      - ${NETWORK_NAME}

volumes:
  mongodb_data_dev:
  mongodb_data_prod:
  redis_data_dev:
  redis_data_prod:
  minio_data_dev:
  minio_data_prod:

networks:
  bourracho-dev-network:
    driver: bridge
  crapulex-dev-network:
    driver: bridge
  crapulex-prod-network:
    driver: bridge
